---
title: "Cleaning Legislative Actions Data"
date: "`r Sys.Date()`"
format: 
  html:
    theme: litera
    toc: true
    code-fold: true
    code-tools: true
editor: visual
---

```{r}
#| label: setup
#| include: false
library(extrafont)
library(tictoc)
library(furrr)
library(here)
library(reactable)
library(reactablefmtr)
plan(multisession)
source("R/parsing_functions.R")

action_codes = read_csv(here("data", "action_codes.csv"), col_types = "cc")

# Load cleaned R objects
all_bills = readRDS(here("data", "cleaned", "BILLSTATUS_117.Rds"))
# actions = readRDS(here("data", "cleaned", "BILLSTATUS_117_Actions.Rds"))
```

First, let's `unnest()` actions from the bills data and see what action-level information looks like.

```{r}
#| column: screen-inset

(actions_unnested = select(all_bills, 
                           where(negate(is_list)), 
                           starts_with("action")) %>% 
   # Unnest actions
  unnest(actions)) %>% 
  head(20) %>% 
  select(bill_id, title, introduced_date, 
         action_date, action_time, 
         action_type, action_code,
         action_text,
         action_source_name, action_committee_name)
```

# Understanding the data

```{r}
glimpse(actions_unnested, width = 80)
```

## Overview

How many bills do we have in the data?

```{r}
n_distinct(actions_unnested$bill_id)
```

How many actions are taken on bills?

```{r}
# Count rows for each bill
add_count(actions_unnested, bill_id, name = "actions") %>% 
  # Count bills by the number of actions
  count(actions, wt = n_distinct(bill_id))
```

```{r}
count(actions_unnested, origin_chamber, bill_id) %>% 
  ggplot(., aes(x = n, fill = origin_chamber))+
  geom_histogram(binwidth = 1, colour = my_col_pal[1], alpha = .7,
                 position = position_identity())+
  scale_x_continuous(expand = expansion(add = c(2, 0)),
                     breaks = scales::breaks_pretty())+
  scale_y_continuous(expand = expansion(add = c(0,400)), 
                     labels = scales::comma)+
  scale_fill_manual(name = NULL, values = viz_colours[1:2])+
  labs(x = "Actions per bill", y = "# Bills", 
       title = "Distribution of congressional bill activity")+
  theme_moke(plots_pane = T)+
  theme(axis.line.y = element_blank(),
        legend.position = c(.9, .9))
```

Which action types occur most often?

```{r}
# Count rows for each bill
add_count(actions_unnested, action_type, name = "actions") %>% 
  add_tally(wt = n_distinct(bill_id), name = "total_bills") %>% 
  # Count bills by the number of actions
  count(action_type, actions, total_bills, 
        wt = n_distinct(bill_id), name = "bills") %>% 
  mutate(pct_of_bills = scales::percent(bills/total_bills)) %>% 
  select(-total_bills)
```

# Cleaning Action Codes

The actions data is messy. There are a number of cases where actions are duplicated in the data which need to reconcile in order to make sense of the legislative timeline. Are we able to identify duplicate actions using action codes?

```{r }
#| label:  action-codes
(actions_joined = actions_unnested %>% 
    # Join actions to the list of action codes
  left_join(action_codes, by = c("action_code" = "Code")))
```

How many of the actions are actually coded?

```{r}
#| label:  action-code-hist
#| fig-height: 6
actions_joined %>% 
  group_by(origin_chamber, bill_id) %>%
  summarise(
    actions = n(),
    actions_w_code = sum(!is.na(Action)),
    actions_coded = actions_w_code/actions,
    .groups = "drop"
  ) %>% 
  # mutate(actions_coded = scales::percent(actions_coded)) %>%
  # count(origin_chamber, actions_coded, wt = n_distinct(bill_id))
  ggplot(., aes(x = actions_coded, fill = origin_chamber))+
  geom_histogram(colour = my_col_pal[1], alpha = .8,
                 position = position_identity())+
  scale_x_continuous(labels = scales::percent, 
                     breaks = scales::breaks_pretty(n = 6), limits = c(0,1))+
  scale_y_continuous(labels = scales::comma, expand = expansion(mult = c(0, .1)))+
  scale_fill_manual(name = NULL, values = viz_colours[1:2])+
  labs(title = "How often are action codes available?",
       subtitle = "Proportion of bills' actions with codes",
       # caption = source_caption("govinfo/US GPO"),
       y = "# of bills", x = "% of actions coded")+
  theme_moke(plots_pane = T)+
  theme(legend.position = c(.9, .9))
```

Are action codes tied to the action source systems?

```{r}
actions_joined %>% 
  # Count actions by action source
  group_by(action_source_name) %>%
  summarise(
    actions = n(),
    actions_w_code = sum(!is.na(Action)),
    actions_coded = scales::percent(actions_w_code/actions),
    .groups = "drop"
  )
```

They're only coming from the Library of Congress. What proportion of the data does each source account for?

```{r}
actions_joined %>% 
  add_tally() %>% 
  group_by(action_source_name) %>% 
  summarise(
    actions = n(),
    proportion = scales::percent(n()/unique(n), accuracy = .1),
    bills = n_distinct(bill_id),
    # bills_pct = bills/sum(bills)
  )
```

Library of Congress accounts for a little under half of the data while the House floor actions source accounts for a little less than a third of actions data.

What action types are contained in each source system?

```{r}
actions_joined %>% 
  add_count(action_source_name, name = "source_actions") %>%
  group_by(action_source_name, action_type) %>% 
  summarise(
    actions = n(),
    # actions_pct = scales::percent(n()/unique(source_actions), accuracy = .1),
    actions_pct = n()/unique(source_actions),
    bills = n_distinct(bill_id),
    # bills_pct = bills/sum(bills)
  )# %>% 
  # pivot_wider(id_cols = action_source_name, 
  #             names_from = action_type, 
  #             values_from = c(actions, actions_pct, bills), 
  #             names_glue = "{action_type}_{.value}",
  #             values_fill = 0) %>% 
  # select(action_source_name, 
  #        starts_with("IntroReferral"), starts_with("Committee"), 
  #        starts_with("Floor"), starts_with("Discharge"), 
  #        starts_with("President"), starts_with("BecameLaw"), starts_with("NA"))
```

The majority of actions from the **House floor actions** source are Intro/Referrals?

How often are action codes present for each action type?

```{r}
#| label: action-codes-summary
actions_joined %>% 
  group_by(action_type) %>% 
  summarise(
    n = n(),
    n_coded = sum(!is.na(action_code)),
    pct_coded = scales::percent(n_coded/n, accuracy = .01)
  )
```

Below are a list of the cases I have found:

-   Action code `E30000` and `36000` with action type `President` and `BecameLaw` respectively appear to both represent the president signing a bill into law, while action codes `E40000` and `36000` with the same respective action types represent a bill becoming a public law. In this case, action type `President` and `BecameLaw` are interchangeable
-   Action code `Intro-H` appears to be a duplicate of action code `1000`, both of which are `IntroReferral` action types

## Intro/Referral

What source system are intro action codes coming from?

```{r }
#| label: intro-action-codes
(intro_actions = actions_joined %>% 
  filter(action_type == "IntroReferral")) %>% 
  count(action_source_name, action_code, sort = T)
```

What are the different intro actions?

```{r}
intro_actions %>% 
  count(action_text, sort = T)
```

Can we categorize these actions?

-   Introduced

-   Referred to committee

-   Read twice and referred to committee

```{r }
#| label: intro-actions
intro_specific_text = c("\\s\\(.+\\)$", "(?<=not later than\\s).+") %>% 
  str_c(collapse = "|")

actions_joined %>% 
  filter(action_type == "IntroReferral") %>% 
  mutate(action_text_general = str_remove_all(action_text, intro_specific_text)) %>% 
  count(action_code, Action, action_text_general) %>% 
  arrange(action_code, desc(n))# %>% 
  # View("Intro/Referral Action Codes")
```

### Action Codes

Below is a table of the action codes and their meaning

| Action Code | Action                                                   | Given/Inferred |
|-------------|----------------------------------------------------------|----------------|
| `1000`      | Introduced in House                                      | Given          |
| `B00100`    | Sponsor introductory remarks on measure                  | Inferred       |
| `H11100`    | Referred to Committee                                    | Inferred       |
| `H11210`    | Committee granted an extension for further consideration | Inferred       |
| `Intro-H`   | Introduced in House                                      | Inferred       |

The `action_code`s **1000** and **Intro-H** seem to be duplicates. Let's look at them.

```{r }
#| label: compare-intro
actions_to_compare = c("1000", "Intro-H")

# Filter to 1000 and Intro-H action codes
(compare_intro_actions = actions_joined %>% 
  filter(action_code %in% actions_to_compare)) %>% 
  glimpse(width = 80)
```

How many bills have both actions? And how many bills does each action occur on?

```{r}
compare_intro_actions %>% 
  # Count actions on each bill
  add_count(bill_id, name = "actions") %>% 
  # Count bills with X actions
  count(actions, wt = n_distinct(bill_id), name = "bills")

# Count bills with action code Y
compare_intro_actions %>% 
  count(action_code, wt = n_distinct(bill_id), name = "bills")
```

When bills have more than one action, is all the information identical other than the action code?

```{r}
compare_intro_actions %>% 
  # Count actions on each bill
  add_count(bill_id, name = "actions") %>% 
  # Keep bills with multiple actions
  filter(actions > 1) %>% 
  arrange(bill_id, action_code) %>% #glimpse(width = 80)
  # Remove columns which are different
  select(-action_code, -Action) %>% 
  distinct_all()
```

Yep

If bills only have one action, which do they have?

```{r}
compare_intro_actions %>% 
  # Count actions on each bill
  add_count(bill_id, name = "actions") %>% 
  # Keep bills with one action
  filter(actions==1) %>% 
  count(action_code)
```

Do all bills with IntroH action codes also have code 1000?

```{r}
introh_bills = compare_intro_actions %>% 
  filter(action_code == "Intro-H") %>% 
  distinct(bill_id) 

# Return intro-H bills which DO NOT have a match
anti_join(introh_bills,
          compare_intro_actions, by = "bill_id")

```

Yep, so we can remove `Intro-H` actions without losing any information. This reduces the size of the actions data by \~8,000 rows.

```{r}
#| label: intro-code-dedupe

(actions_intro_dedupe = actions_joined %>% 
  # Remove Intro-H action codes (keep NAs)
  filter(replace_na(action_code != "Intro-H", T)) %>% 
  arrange(bill_id, action_date, action_time)) %>% 
  glimpse(width = 80)
```

## Committee

What actions do we have for committees?

```{r}
(committee_actions = actions_joined %>% 
  filter(action_type == "Committee")) %>% 
  count(action_code, Action)
```

The majority of committee actions don't have action codes. We also have 3 action codes which aren't in the codes provided by govinfo.

Can we tell what they are?

```{r}
committee_actions %>% 
  filter(!is.na(action_code), is.na(Action)) %>% 
  select(action_code, bill_id, action_date, action_text, everything()) %>% 
  arrange(action_code, bill_id)
```

H12200 and H12100 look similar but might not be identical. Do bills have both?

```{r}
committee_actions %>% 
  filter(action_code %in% c("H12200", "H12100")) %>% 
  add_count(bill_id) %>% 
  count(n)
```

Nope, so they're likely distinct actions. What about H12210?

```{r}
committee_actions %>% 
  filter(action_code == "H12210") %>% 
  select(action_code, bill_id, action_date, action_text, everything()) %>% 
  arrange(action_code, bill_id)
```

What committee actions do we have coded? And which source is providing the codes?

```{r }
#| label: committee-actions
committee_actions %>% 
  count(action_code, Action, sort = T)# %>% 
  # View("Committee Action Codes")

committee_actions %>% 
  add_count(action_source_name, name = "source_actions") %>%
  group_by(Action, action_source_name) %>% 
  summarise(
    actions = n(),
    actions_pct = scales::percent(n()/unique(source_actions), accuracy = .1),
    bills = n_distinct(bill_id),
    # bills_pct = bills/sum(bills)
  )
  

```

| Action Code | Action                                    | Given/Inferred |
|-------------|-------------------------------------------|----------------|
| `14000`     | Reported to Senate                        | Given          |
| `14500`     | Senate committee discharged               | Given          |
| `5000`      | Reported to House                         | Given          |
| `5500`      | House committee discharged                | Given          |
| `H12100`    | House committee reported original measure | Inferred       |
| `H12200`    | Reported or amended by committee          | Inferred       |
| `H12210`    | Supplemental report filed                 | Inferred       |

: Committee Action Codes

What about the actions which don't have a code? Let's see how many we can categorize with some regex:

```{r}
committee_actions %>% 
  filter(is.na(action_code)) %>% 
  count(action_text) %>% View("committee action texts")

(committee_actions_categorised = committee_actions %>% 
  filter(is.na(action_code)) %>% 
  mutate(committee_action_cat = case_when(
    str_detect(action_text, 
               "Referred to the Subcommittee") ~ "Referred to Subcommittee",
    # str_detect(action_text, 
    #            "Ordered to be reported without amendment favorably") ~ "Ordered to be reported without amendment favorably.",
    str_detect(action_text, 
               "Ordered to be reported with an amendment in the nature of a substitute favorably") ~ "Ordered to be reported with an amendment in the nature of a substitute favorably",
    str_detect(action_text, 
               "Ordered to be reported with (an )?amendments? favorably") ~ "Ordered to be reported with an amendment favorably",
    str_detect(action_text,
               "[Rr]eported(\\sby Senator [A-z\\s]+)? with (an )?amendments?") ~ "Reported with amendment(s)",
    str_detect(action_text,
               "[Rr]eported(\\sby Senator [A-z\\s]+)? without amendment") ~ "Reported without amendment",
    str_detect(action_text, 
               "Original measure reported to Senate") ~ "Original measure reported to Senate",
    str_detect(action_text, 
               "Hearings held\\.") ~ "Hearings held",
    str_detect(action_text, 
               "Committee consideration held") ~ "Committee consideration held",
    str_detect(action_text,
               "Failed to report favorably") ~ "Failed to report favorably",
    str_detect(action_text,
               "Executive Comment Received") ~ "Executive Comment Received",
    str_detect(action_text,
               "Executive Comment Requested") ~ "Executive Comment Requested",
    str_detect(action_text,
               "Forwarded by Subcommittee to Full Committee") ~ "Forwarded to Full Committee",
    str_detect(action_text,
               "Ordered to be Reported \\(Amended\\)") ~ "Ordered to be Reported (Amended)",
    str_detect(action_text,
               "Ordered to be Reported") ~ "Ordered to be Reported",
    str_detect(action_text,
               "Subcommittee (.+) Discharged\\.$") ~ "Subcommittee Discharged",
    T ~ action_text
    # str_detect(action_text, "Ordered to be reported without amendment favorably") ~ "Ordered to be reported without amendment favorably.",
    
  ))) %>% 
  count(committee_action_cat, sort = T)
```

Do committees

```{r}

```

Check the action texts in each category

```{r}
committee_actions_categorised %>% 
  count(committee_action_cat, action_text) %>% View("committee action categories")
  arrange(committee_action_cat, action_text) %>% 
  select(committee_action_cat, action_text, everything())
  
```

Committee actions which do not have an action code include the following types of actions:

-   Referred to Subcommittee

-   Committee /Subcommittee Hearings Held

-   Ordered to be Reported

    -   in the Nature of a Substitute

    -   by Voice Vote/Unanimous Consent/the Yeas and Nays

-   Subcommittee Consideration and Mark-up Session Held

-   Subcommittee discharged

-   Forwarded by Subcommittee to Full Committee by Voice Vote

-   Executive Comment Requested/Received

Which come from which source?

## Floor

```{r }
#| label: floor-action-codes
actions_joined %>% 
  filter(action_type == "Floor") %>% 
  count(action_source_name, action_code, sort = T)
```

```{r }
#| label: floor-actions
actions_joined %>% 
  filter(action_type == "Floor") %>% 
  add_count(action_code, name = "action_code_count") %>% 
  # Select distinct action codes and their descriptions
  distinct(action_code, action_code_count,
           Action, action_text_trunc = str_trunc(action_text, width = 60),
           action_text) %>%
  # sort by frequency
  arrange(desc(action_code_count), action_code) %>% 
  head()# %>% 
  # View("Floor Action Codes")
```

+-------------+----------------------------------------------------------------------------------------------+----------------+
| Action Code | Action                                                                                       | Given/Inferred |
+=============+==============================================================================================+================+
| `17000`     | Passed/agreed to in Senate                                                                   | Given          |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `8000`      | Passed/agreed to in House                                                                    | Given          |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `9000`      | Failed of passage/not agreed to in House                                                     | Given          |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `E20000`    | Presented to President                                                                       | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H12700`    | Provision of consideration and/or debate                                                     | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H1B000`    | Pursuant to provisions of H. Res. 41/85/330/380/403/473/486/504/ 535/601/912, resolution is: | Inferred       |
|             |                                                                                              |                |
|             | -   considered passed House                                                                  |                |
|             |                                                                                              |                |
|             | -   considered vacated                                                                       |                |
|             |                                                                                              |                |
|             | -   laid on the table                                                                        |                |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H1L210`    | Rules committee resolution reported to house                                                 | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H1L220`    | Rule passed House                                                                            | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H30000`    | Considered:                                                                                  | Inferred       |
|             |                                                                                              |                |
|             | -   as privileged matter                                                                     |                |
|             |                                                                                              |                |
|             | -   as unfinished business                                                                   |                |
|             |                                                                                              |                |
|             | -   by unanimous consent                                                                     |                |
|             |                                                                                              |                |
|             | -   under suspension of the rules                                                            |                |
|             |                                                                                              |                |
|             | -   under provisions of rule H. Res. XXX                                                     |                |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H30200`    | -   Request for unanimous consent to consider bill                                           | Inferred       |
|             |                                                                                              |                |
|             | -   Chair lays bill before the House w/o objection                                           |                |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H30300`    | Move to suspend rules and pass the bill/agree to the resolution                              | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H30800`    | Consideration initiated                                                                      | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H35000`    | Previous question ordered:                                                                   | Inferred       |
|             |                                                                                              |                |
|             | -   pursuant to the rule                                                                     |                |
|             |                                                                                              |                |
|             | -   pursuant to a previous order of the House                                                |                |
|             |                                                                                              |                |
|             | -   agreed to by vote                                                                        |                |
|             |                                                                                              |                |
|             | -   without objection                                                                        |                |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H36100`    | Move to commit w/instructions to a Select committee                                          | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H36110`    | Failed move to commit w/instructions                                                         | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H36200`    | Move to recommit to committee                                                                | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H36210`    | Failed move to recommit to committee                                                         | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H36500`    | Move to table the measure                                                                    | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H36510`    | Passed move to table the measure                                                             | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H36600`    | Move to:                                                                                     | Inferred       |
|             |                                                                                              |                |
|             | -   reconsider                                                                               |                |
|             |                                                                                              |                |
|             | -   table motion to reconsider                                                               |                |
|             |                                                                                              |                |
|             | -   agree                                                                                    |                |
|             |                                                                                              |                |
|             | -   postpone consideration                                                                   |                |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H36610`    | Passed move to:                                                                              | Inferred       |
|             |                                                                                              |                |
|             | -   reconsider                                                                               |                |
|             |                                                                                              |                |
|             | -   table motion to reconsider                                                               |                |
|             |                                                                                              |                |
|             | -   agree                                                                                    |                |
|             |                                                                                              |                |
|             | -   postpone consideration                                                                   |                |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H36700`    | Move to refer to a select committee                                                          | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H37100`    | Passage of/agreeing to resolution                                                            | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H37220`    | Vote demanded at conclusion of debate                                                        | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H37300`    | Vote on motion to suspend the rules and pass the bill /                                      | Inferred       |
|             |                                                                                              |                |
|             | Passage of bill under suspension of rules                                                    |                |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H38310`    | Motion to reconsider laid on the table                                                       | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H38400`    | Move to reconsider vote                                                                      | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H38410`    | Vote on motion to reconsider                                                                 | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H38800`    | Measure title amended                                                                        | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H38900`    | Clerk authorized to make technical and formatting corrections                                | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H8A000`    | Previous question on the motion was ordered                                                  | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+
| `H8D000`    | Debate                                                                                       | Inferred       |
+-------------+----------------------------------------------------------------------------------------------+----------------+

: Floor Action Codes

```{r }
#| label: floor-missing-codes
actions_joined %>% 
  filter(action_type == "Floor", is.na(action_code)) %>% 
  count(action_text, sort = T)# %>% 
  # View("Floor Actions missing codes")
```

Floor actions which do not have an action code appear to be Senate actions, but include the following types of actions:

-   Message on Senate action sent to the house

-   Passed Senate w/o amendment by Unanimous Consent/Voice Vote

-   Passed Senate with amendment

-   Cloture motion

    -   on the measure

    -   on the motion to proceed to the measure

    -   invoked/not invoked

-   Motion to proceed to consideration of measure in Senate

-   Motion to proceed to consideration of measure *agreed to* in Senate

-   Received, considered, and agreed to in the senate

-   Considered by Senate

-   Measure laid before Senate (by motion/unanimous consent)

-   Motion to commit to Senate Committee

-   Motion to appeal the ruling of the chair

-   Motion to reconsider cloture vote

## Discharge

```{r}
#| label: discharge-action-codes
actions_joined %>% 
  filter(action_type == "Discharge") %>% 
  count(action_source_name, action_code, sort = T)
```

```{r }
#| label: discharge-actions
actions_joined %>% 
  filter(action_type == "Discharge") %>% 
  add_count(action_code, name = "action_code_count") %>% 
  # Select distinct action codes and their descriptions
  distinct(action_code, action_code_count,
           Action, action_text_trunc = str_trunc(action_text, width = 60),
           action_text) %>%
  # sort by frequency
  arrange(desc(action_code_count), action_code) %>% 
  head()# %>% 
  # View("Discharge Action Codes")

```

| Action Code | Action                         | Given/Inferred |
|-------------|--------------------------------|----------------|
| `H12300`    | Committee discharged           | Inferred       |
| `H17000`    | Motion to discharge committee  | Inferred       |
| `H12490`    | Discharged from House Calendar | Inferred       |

: Discharge Action Codes

## President

```{r }
#| label: president-action-codes
actions_joined %>% 
  filter(action_type == "President") %>% 
  count(action_source_name, action_code, sort = T)
```

```{r }
#| label: president-actions
actions_joined %>% 
  filter(action_type == "President") %>% 
  add_count(action_code, name = "action_code_count") %>% 
  # Select distinct action codes and their descriptions
  distinct(action_code, action_code_count,
           Action, action_text_trunc = str_trunc(action_text, width = 60),
           action_text) %>%
  # sort by frequency
  arrange(desc(action_code_count), action_code) %>% 
  head()# %>% 
  # View("President Action Codes")
```

| Action Code | Action                 | Given/Inferred |
|-------------|------------------------|----------------|
| `28000`     | Presented to President | Given          |
| `E30000`    | Signed by President    | Inferred       |
| `E40000`    | Became Public Law      | Inferred       |

: President Action Codes

## Became Law

```{r }
#| label:  becamelaw-action-codes
actions_joined %>% 
  filter(action_type == "BecameLaw") %>% 
  count(action_source_name, action_code, sort = T)

```

```{r}
#| label: becamelaw-actions
actions_joined %>% 
  filter(action_type == "BecameLaw") %>% 
  add_count(action_code, name = "action_code_count") %>% 
  # Select distinct action codes and their descriptions
  distinct(action_code, action_code_count,
           Action, action_text_trunc = str_trunc(action_text, width = 60),
           action_text) %>%
  # sort by frequency
  arrange(desc(action_code_count), action_code) %>% 
  head()# %>% 
  # View("Became Law Action Codes")
```

| Action Code | Action            | Given/Inferred |
|-------------|-------------------|----------------|
| `36000`     | Became Public Law | Given          |

: Became Law Action Codes

## Missing Action Type

```{r }
#| label:  missing-actions
actions_joined %>% 
  filter(action_type == "(Missing Action Type)") %>% 
  count(action_source_name, action_code) %>% 
  arrange(action_code, desc(n))

```

```{r}
#| label:  missing-action-codes
actions_joined %>% 
  filter(action_type == "(Missing Action Type)") %>% 
  add_count(action_code, name = "action_code_count") %>% 
  # Select distinct action codes and their descriptions
  distinct(action_source_name, action_code, action_code_count,
           Action, action_text_trunc = str_trunc(action_text, width = 60),
           action_text) %>%
  # sort by frequency
  arrange(desc(action_code_count), action_code) %>% 
  head()# %>% 
  # View("Missing Type Action Codes")
```

| Action Code | Action                                                                            | Given/Inferred |
|-------------|-----------------------------------------------------------------------------------|----------------|
| `H12410`    | Placed on the Union Calendar                                                      | Inferred       |
| `H12420`    | Placed on the House Calendar                                                      | Inferred       |
| `H41931`    | Result of motion to reconsider                                                    | Inferred       |
| `19500`     | Resolving differences                                                             | Inferred       |
| `H41610`    | Result of motion that the House agree to Senate amendment                         | Inferred       |
| `H82000`    | Move to table motion to reconsider/postpone consideration/refer                   | Inferred       |
| `H12440`    | Motion to place bill on consensus calendar                                        | Inferred       |
| `H41400`    | Previous question ordered pursuant to rule/previous House order                   | Inferred       |
| `H12430`    | Placed on the Private Calendar                                                    | Inferred       |
| `H40110`    | Request unanimous consent that the House to agree to Senate amendment(s)          | Inferred       |
| `H40140`    | Move to suspend rules and agree to Senate amendment(s)                            | Inferred       |
| `H40150`    | Move that the House agree to Senate amendment(s)                                  | Inferred       |
| `80000`     | Amendment failed by the House                                                     | Inferred       |
| `H30230`    | An objection was heard to the unanimous consent request to consider the measure.  | Inferred       |
| `H40130`    | House moved to agree to the Senate amendment, pursuant to previous special order. | Inferred       |
| `H41930`    | Move to reconsider the vote                                                       | Inferred       |

: Missing Action Type Action Codes

# Order of (legislative) operations

What is the chronological order of legislative actions? Based on this [map of legislative status steps](https://www.loc.gov/pictures/resource/ppmsca.33996/), it is not entirely straightforward. `action_date` and `action_time` are two fields which should provide some insight here. Unfortunately, `action_time` is missing in 90% of cases.

```{r}
# Calculate how many actions are missing date and time data
actions_unnested %>% 
  summarise(
    n_actions = n(),
    across(c(action_date, action_time), 
           list(data_points = ~scales::comma(sum(!is.na(.), na.rm = T)), 
                pct = ~scales::percent(sum(!is.na(.), na.rm = T)/n_actions, accuracy = .01)))
  ) %>% 
  # Pivot summary for table
  pivot_longer(cols = starts_with("action"), 
               names_to = c("field", ".value"), names_sep = "(?<=e)_")
```

Because time information is missing and often actions of different types occur on the same day, we need to make use `action_type` to identify the order of actions.

## Assumption

Congressional actions follow the following order:\
Intro/Referral -\> Committee -\> Discharge -\> Floor -\> President -\> Become Law

Because actions can occur on the same date and we do not know the time, this assumption is useful to infer the order of actions.

```{r}
actions_order = c("IntroReferral", "Committee", 
                  "Discharge", "Floor", "President", "BecameLaw")
```

Let's see an example of a case where different action types have the same date with no time information:

```{r}
#| label: actions-example
#| column: page
unclear_action_example = actions_unnested %>% 
  filter(bill_id == "HR-1002") %>% 
  arrange(action_date, action_time)

unclear_action_example %>% 
  select(action_date, action_time, action_type, action_text) %>% 
  reactable(theme = moke_rt(),
            columns = list(
              "action_text" = colDef(width = 264)
            )) %>% 
  add_title(unique(unclear_action_example$title)) %>% 
  add_subtitle("Example of ambiguous congressional action order")
```

```{r}

(actions_coded = actions_unnested %>% 
    # Create action timestamp
    mutate(action_ts = make_datetime(year = year(action_date), 
                                     month = month(action_date), 
                                     day = day(action_date), 
                                     hour = coalesce(hour(action_time), 0), 
                                     min = coalesce(minute(action_time), 0), 
                                     sec = coalesce(second(action_time), 0), 
                                     tz = "US/Eastern"),
           # Set action type order
           action_type_fct = fct_explicit_na(
             factor(action_type, 
                    levels = actions_order, 
                    ordered = T),
             na_level = "(Missing Action Type)"
           ),
           action_source_name = factor(action_source_name,
                                       levels = c("Library of Congress", 
                                                  "House floor actions", 
                                                  "House committee actions",
                                                  "Senate"),
                                       ordered = T)) %>% 
    arrange(bill_id, action_ts) %>% 
    select(-action_date, action_time) %>% 
    relocate(action_ts, action_type, action_text, 
                    action_code, action_type_fct,
                    action_source_name, action_source_code,
                    starts_with("action_committee"), .after = title)) %>% 
  select(title, bill_id, starts_with("action"))
```

What action types are most common?

```{r}
#| label: count-action-type
actions_coded %>%
  count(bill_type, action_type) %>% 
  arrange(bill_type, desc(n)) %>% 
  pivot_wider(names_from = action_type, values_from = n, values_fill = 0)
```

Or in a graph:

```{r}
#| label: action-type-prop
#| fig.width: 10
#| fig.height: 6
actions_coded %>%
  count(bill_type, action_type) %>% 
  arrange(bill_type, n) %>% 
  # Calculate % of bill's actions
  group_by(bill_type) %>% 
  mutate(pct = n/sum(n),
         pct_lab = if_else(pct > .08, scales::percent(pct, accuracy = .1), NA_character_)) %>% 
  ungroup() %>%
  # Plot
  ggplot(., aes(y = bill_type, fill = fct_rev(action_type)))+
  geom_col(aes(x = n), 
           colour = my_col_pal[1], width = .6, 
           position = position_fill())+
  geom_text(aes(x = n, label = pct_lab), 
           position = position_fill(vjust = .5),
           family = "Heebo Light", fontface = "bold",
           colour = my_col_pal[1],
           size = 5)+
  scale_x_continuous(name = NULL, 
                     labels = scales::percent, 
                     breaks = scales::breaks_pretty(),
                     expand = expansion(add = .01))+
  scale_fill_manual(name = "Action\nType", 
                    values = viz_colours[length(unique(actions_unnested$action_type)):1],
                    guide = guide_legend(title.position = "left", 
                                         title.hjust = .5,
                                         label.position = "top", 
                                         keywidth = unit(2.5, "cm"),
                                         #direction = "horizontal", 
                                         nrow = 1, reverse = T))+
  labs(title = "Most common congressional actions taken on bills",
       subtitle = "Actions as proportion of total bill activity, by bill type",
       y = NULL)+
  # facet_wrap(~bill_type, scales = "free_y")+
  theme_moke(plot_margin = margin(20,20,20,20))+
  # theme_minimal()+
  theme(legend.position = "top",
        axis.line.y = element_blank(),
        legend.title = element_text(margin = margin(l = 0, r = 20)),
        legend.box.just = "left",
        panel.grid.major.y = element_blank(), 
        panel.grid.major.x = element_line())
```

Can we get an idea of the order of actions based on their average position in the data?

```{r}
#| label:  action-order-summary
#| eval: false
(action_order_summary = actions_coded %>% 
  group_by(bill_type, action_type) %>% 
  summarise(across(action_number, list(min = min, 
                                       y25 = ~quantile(., .25), 
                                       mean = mean, median = median, 
                                       y75 = ~quantile(., .75),
                                       max = max), na.rm=T)))
```

```{r}
#| label:  action-order-boxplot
#| eval: false
action_order_summary %>%
  pivot_longer(
    cols = starts_with("action_n"), 
    names_to = "measure", values_to = "value",
    names_transform = list(
      measure = ~str_remove_all(., "^action_number_")
      )
    )

action_order_summary %>% 
  ggplot(., aes(x = action_type))+
  geom_boxplot(
    aes(ymin = action_number_min, 
        lower = action_number_y25, 
        middle = action_number_median, 
        upper = action_number_y75,
        ymax = action_number_max),
    stat = "identity"
  )+
  facet_wrap(~bill_type)+
  theme_moke(plots_pane = T)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r }
#| label:  action-order-boxplot2
#| eval: false
actions_unnested %>% 
  group_by(action_type) %>% 
  mutate(mean_num = mean(action_number)) %>% 
  ungroup() %>% 
  arrange(mean_num) %>% 
  mutate(action_type = fct_inorder(factor(action_type))) %>% 
  ggplot(., aes(x = action_type, y = action_number))+
  geom_boxplot()+
  labs(title = "In what order do actions typically occur?", x = NULL)+
  facet_wrap(~bill_type)+
  theme_moke(plots_pane = T)

```

```{r }
#| label:  sample-actions-plot
actions_unnested %>% 
  filter(bill_id == sample(bill_id, 1)) -> sample_bill_actions

sample_bill_actions %>% 
  # Plot
  ggplot(., aes(x = action_date))+
  # Line connecting points
  geom_line(aes(y = ..count.., group = bill_id), stat = "count", size = .8, alpha = .8)+
  # Points using the count of each action type on a given date
  geom_point(aes(colour = action_type, size = ..count..), stat = "count")+
  labs(title = "Bill actions over time", 
       x = "Action Date", y = "# of actions")+
  scale_size(guide = "none", range = c(2,7))+
  theme_moke(plots_pane = T)
```
