---
title: "Explore Bill Status bulk data"
output: 
  html_notebook:
    df_print: paged
---

The goal of exploring legislative data is to provides citizens with a clearer view of who their representatives are and what they are doing.
An ideal solution combines Datamade's [beautifully simple representative finder](https://myreps.datamade.us/) and Project Vote Smart's [vast collection of data on legislator activities](https://justfacts.votesmart.org/).

Other questions worth investigating:

- how long does it take for a bill to become law?
- which legislative processes are the most time-intensive?
- which decision-makers are acting in each stage?
- what legislative paths can a bill take?
map the legislative process for bills and get a sense for how legislator behaviour affects a bill's likelihood of being considered, its content, and the eventual outcome
- Make a sankey diagram depicting how bills flow through congress

It might be worth reaching out to: https://github.com/unitedstates/congress

```{r setup}
library(extrafont)
library(tictoc)
library(furrr)
library(here)
library(reactable)
plan(multisession)
source("R/parsing_functions.R")

# action_codes = read_csv(here("data", "action_codes.csv"), col_types = "cc")
```

I have downloaded all the different bill types for the 117th congress from https://www.govinfo.gov/bulkdata/BILLSTATUS/117/.
Below is the structure of this directory

```{r}
fs::dir_tree(here("data", "BILLSTATUS", "117"), recurse = F)
```

# Parse House bills

First we'll parse bills which were introduced in the house, or the bill types beginning with "h".
With the directory structure, I create a list of files by bill type.

```{r}
house_bill_types = list.files(here("data", "BILLSTATUS","117"), pattern = "^h")

(house_bill_folders = here("data", "BILLSTATUS", "117", 
                          house_bill_types) %>% 
    str_remove_all("\\/OneDrive"))

house_bill_files = map(house_bill_folders, list.files, full.names = T) %>% 
  set_names(house_bill_types)

```

Let's check how many bill XML files are in each folder.
House-originated bills (H.R.) are by far the most common, while simple resolutions (H. Res.) are the second most common.
Joint resolutions (H.J. Res.) and concurrent resolutions are introduced much less frequently.

```{r}
house_bill_files  %>% 
  map(length)
```

## Examine single bill

What does the data look like for a single bill?

```{r}
# Sample a bill
sample_bill_file = sample(house_bill_files$hr, 1)

# Extract the bill status data
(sample_bill_df = extract_bill_status(sample_bill_file, 
                                     get_votes = F,
                                     log_types = "console"))

# View the bill's contents
glimpse(sample_bill_df)

```

View the bill in a table (Note I have a preference for the date format `dd/mm/yyyy` so that is the format used here)

```{r sample-bill-rt}
select(sample_bill_df, 
       title, bill_id, createDate, introducedDate, where(negate(is_list)),
       -constitutionalAuthorityStatementText) %>% 
  reactable(
    columns = list(
      originChamber = colDef(name = "Chamber of Origin", width = 80),
      bill_id = colDef(name = "ID", width = 70),
      congress = colDef(show = F, width = 60),
      billType = colDef(show = F,name = "Bill Type", width = 50),
      billNumber = colDef(show = F,name = "Bill #", width = 40),
      title = colDef(name = "Bill Title", width = 420),
      createDate = colDef(name = "Created", width = 80,
                          format = colFormat(date = T, locales = "en-GB")),
      latestAction_actionDate = colDef(name = "Date", width = 80,
                                       format = colFormat(date = T, locales = "en-GB")),
      latestAction_text = colDef(name = "Action", width = 320),
      version = colDef(show=F),
      updateDate = colDef(name = "Updated", width = 80,
                          format = colFormat(date = T, locales = "en-GB")),
      introducedDate = colDef(name = "Introduced", width = 80, 
                              format = colFormat(date = T, locales = "en-GB"))
    ),
    columnGroups = list(
      colGroup(name = "Latest Action",
               columns = c("latestAction_actionDate", "latestAction_text"))
    )
  )
```


### Actions

What actions are taken on a bill?
After a bill is introduced, how do members of congress interact with it? 

To answer questions like these, we need to `unnest()` the `actions` column.

```{r sample-actions}
(sample_actions = sample_bill_df %>% 
  select(billType, billNumber, bill_id, title, createDate, updateDate, title,
         -where(is_list), actions) %>%
  unnest(actions) %>% 
   select(bill_id, 
          action_type, actionCode, action_text, any_of(c("actionDate", "actionTime")), 
         action_source_name, action_source_code,
         action_committee_name, action_committee_systemCode,
         everything()) %>% 
   # Order bills and actions
  arrange(billType, billNumber, actionDate))
```

Let's visualize what this timeline might look like, counting the number of each type of action taken.

```{r sample-action-timeline}
sample_actions %>% 
  # Sort cols and rows
  select(bill_id, billType, billNumber, action_type, actionDate, action_text, action_committee_name, action_source_name) %>%
  arrange(billType, billNumber, actionDate, action_type) %>% 
  # Plot
  ggplot(., aes(y = action_type, x = actionDate))+
  # Line connecting points
  geom_line(aes(group = bill_id), size = .8, alpha = .9, colour = my_col_pal[2])+
  # Points using the count of each action type on a given date
  geom_jitter(aes(colour = action_type), 
              size = 3, alpha = .85, 
              show.legend = F,
              height = 0.025, width = 2.5)+
  labs(title = "Bill actions over time")+
  scale_x_date(name = "Action Date")+
  # scale_y_continuous(name = "# of actions", 
  #                    breaks = scales::breaks_width(1), limits = c(0, NA))+
  scale_colour_manual(values = viz_colours[1:length(unique(sample_actions$action_type))])+
  scale_size(guide = "none", range = c(2,7))+
  theme_moke(plots_pane = T)+
  theme(legend.position = "top", legend.justification = "left")
```

However, it looks like we will need to clean the actions because there appears to be a lot of duplicate `IntroReferral` actions.
Below is a table of these actions in our sample bill: `r sample_bill_df$bill_id`

```{r}
sample_actions %>% 
  filter(action_type == "IntroReferral") %>% 
  select(bill_id, title, actionDate, action_type, actionCode, action_text, action_source_name, action_committee_name)
```


## Create House bills dataset

```{r sample-hr-bills, eval=F}
# Test for sample
# Extract bill data for a sample of house bills
hr_sample = sample(house_bill_files$hr, 1000)
```

```{r extract-sample-bills, eval=F}
tic(str_c("Extract ", length(hr_sample), " bills"))
(hr_bills = hr_sample %>% # house_bill_files$hr %>% 
  future_map_dfr(extract_bill_status, get_votes = F, log_types = "console") %>% 
    mutate(
      across(ends_with("Date"), as_datetime),
      actions = map(actions, mutate, 
                    action_type = factor(action_type, 
                                         levels = c("IntroReferral", "Committee", "Floor", 
                                                    "Discharge", "President", "BecameLaw"), 
                                         ordered = T))
      ))
toc()

```

```{r sample-hr-glimpse, eval=F}
glimpse(hr_bills)
```

First combine the bill file list into a single vector and question whether they should even be in a list.
Then run our `extract_bill_status()` function on all of our bills, in parallel using `{furrr}` to save some time.

```{r, eval=F, echo = T}
all_files = flatten_chr(house_bill_files)

tic(str_c("Extract ", sum(map_dbl(house_bill_files, length)), " bills"))
(all_bills = future_map_dfr(all_files, extract_bill_status, log_types = "console"))
toc()
```

Save this object for use later

```{r}
# saveRDS(all_bills, here("data", "cleaned", "BILLSTATUS_117_House.Rds"))
all_bills = readRDS(here("data", "cleaned", "BILLSTATUS_117_House.Rds"))
```




### Actions

The actions tibbles are not necessarily structurally consistent.
What fields are present and when?

```{r}
all_bills %>% 
  select(bill_id, actions) %>% 
  # Create a list of field names for each actions dataframe
  mutate(actions_cols = map(actions, colnames)) %>% 
  unnest(actions_cols) %>%
  # Count the number of bills the field is available for
  count(actions_cols, wt = n_distinct(bill_id), sort = T)
```

Committee information is missing for a very small number of cases and timing information is missing for the vast majority of actions.
When is time information available?

```{r}
bind_rows(house_bills) %>% 
  select(bill_id, actions) %>%
  unnest(actions) %>% 
  # Filter to rows with a time
  filter(!is.na(actionTime)) %>% 
  count(action_type, sort = T)
```

Now, let's `unnest()` the actions data and see what action-level information looks like.

```{r}
(actions_unnested = map(house_bills, select, where(negate(is_list)), starts_with("action")) %>% 
   # Unnest actions
  map_dfr(unnest, actions))
```


What action types are most common?

```{r}
actions_unnested %>%
  count(billType, action_type) %>% 
  arrange(billType, desc(n))
```
Or in a graph:

```{r}
actions_unnested %>%
  count(billType, action_type) %>% 
  arrange(billType, desc(n)) %>% 
  ggplot(., aes(x = action_type, y = n, fill = action_type))+
  geom_col()+
  scale_y_continuous(labels = scales::comma)+
  scale_fill_manual(name = "Action", 
                    values = viz_colours[1:length(unique(actions_unnested$action_type))])+
  facet_wrap(~billType, scales = "free_y")+
  theme_mark(plots_pane = T)+
  theme(axis.text.x = element_blank())
```
What about action codes?

```{r}
actions_unnested %>% 
  left_join(action_codes, by = c("actionCode" = "Code")) %>% 
  select(bill_id, actionDate, actionTime, action_type, actionCode, Action) %>% 
  count(actionCode, Action, sort = T)
```


```{r}
actions_unnested %>% 
  left_join(action_codes, by = c("actionCode" = "Code")) %>% 
  group_by(bill_id) %>%
  summarise(
    actions = n(),
    actions_w_code = sum(!is.na(Action)),
    actions_coded = actions_w_code/actions
  ) %>% 
  ggplot(., aes(x = actions_coded))+
  geom_histogram()+
  scale_x_continuous(labels = scales::percent)+
  scale_y_continuous(labels = scales::comma, expand = expansion())+
  theme_mark(plots_pane = T)
```

### Action Codes

The actions data is messy.
There are a number of cases where actions are duplicated in the data which need to reconcile in order to make sense of the legislative timeline.
Below are a list of the cases I have found:

- Action code `E30000` and `36000` with action type `President` and `BecameLaw` respectively appear to both represent the president signing a bill into law, while action codes `E40000` and `36000` with the same respective action types represent a bill becoming a public law. In this case, action type `President` and `BecameLaw` are interchangeable
- Action code `Intro-H` appears to be a duplicate of action code `1000`, both of which are `IntroReferral` action types


How do actions with actionCodes listed on congress.gov differ from those which are not?

```{r}
actions_unnested %>% 
  filter(bill_id == sample(bill_id, 1)) %>% 
  left_join(action_codes, by = c("actionCode" = "Code")) %>% 
  select(bill_id, actionDate, actionTime, action_type, actionCode, Action, action_text, starts_with("action"))
```


How do action codes relate to action sources?

```{r}
actions_unnested %>% 
  count(action_source_name, actionCode, str_trunc(action_text, 50), sort = T)
```

Is there a difference between the `actionCode` **1000** and **Intro-H**?

```{r}
actions_to_compare = c("1000", "Intro-H")

actions_unnested %>% 
  filter(actionCode %in% actions_to_compare)
  
```

Do these two actions occur for every bill?

```{r}
actions_unnested %>% 
  filter(actionCode %in% actions_to_compare) %>% 
  count(actionCode)
```

No, **1000** occurs more often.

Does `Intro-H` **only occur** in cases where `1000` is present too?

```{r}
actions_unnested %>% 
  group_by(bill_id) %>% 
  filter(actionCode %in% actions_to_compare,
         "Intro-H" %in% actionCode) %>% 
  ungroup() %>% 
  count(actionCode)
```

So effectively we can remove `Intro-H` actions.
This reduces the size of the actions data by ~8,000 rows.

```{r}
actions_unnested %>% 
  select(bill_id, title, introducedDate, 
         actionDate, actionTime, action_type, actionCode, action_text,
         starts_with("action_source"), starts_with("action_committee")) %>% 
  filter(actionCode != "Intro-H"|is.na(actionCode)) %>% 
  mutate(action_ts = make_datetime(year = year(actionDate), month = month(actionDate), day = day(actionDate), 
                                   hour = coalesce(hour(actionTime), 0), 
                                   min = coalesce(minute(actionTime), 0), 
                                   sec = coalesce(second(actionTime), 0), 
                                   tz = "US/Eastern"), .before = actionDate) %>% 
   arrange(bill_id, action_ts)
```



```{r}
# Reduce data down to bill-level attributes and the actions data
(house_bill_actions = map(house_bills, select, where(negate(is_list)), starts_with("action")) %>% 
   # Unnest actions
  map_dfr(unnest, actions) %>% 
   # Remove Intro-H actions
   filter(actionCode != "Intro-H"|is.na(actionCode)) %>% 
  mutate(action_ts = make_datetime(year = year(actionDate), month = month(actionDate), day = day(actionDate), 
                                   hour = coalesce(hour(actionTime), 0), 
                                   min = coalesce(minute(actionTime), 0), 
                                   sec = coalesce(second(actionTime), 0), 
                                   tz = "US/Eastern")) %>% 
   left_join(action_codes, by = c("actionCode" = "Code")) %>% 
   # Order bills and actions
  arrange(billType, billNumber, action_ts) %>% 
   # Number actions
  group_by(billType, billNumber) %>% 
  mutate(action_number = row_number(),
         became_law = ("BecameLaw" %in% action_type), .after = actionTime) %>% 
  ungroup()) %>% 
  glimpse()
```

```{r}
house_bill_actions %>% 
  count(action_type, sort = T)
```

View number of actions taken on a bill by whether or not they became law

```{r}
house_bill_actions %>% 
  group_by(bill_id) %>% 
  mutate(became_law = ("BecameLaw" %in% action_type)) %>% 
  ggplot(., aes(x = action_ts, y = action_number))+
  geom_line(aes(group = bill_id, colour = became_law))+
  facet_wrap(~billType, scales = "free_y")+
  theme_mark(plots_pane = T)
```


Can we get an idea of the order of actions based on their average position in the data?

```{r}
(action_order_summary = house_bill_actions %>% 
  group_by(action_type) %>% 
  summarise(across(action_number, list(min = min, 
                                       y25 = ~quantile(., .25), 
                                       mean = mean, median = median, 
                                       y75 = ~quantile(., .75),
                                       max = max), na.rm=T)))
```

```{r}
action_order_summary %>%
  pivot_longer(cols = starts_with("action_n"), names_to = "measure", values_to = "value",
               names_transform = list(measure = ~str_remove_all(., "^action_number_")))

action_order_summary %>% 
  arrange(action_number_mean) %>% 
  mutate(action_type = fct_inorder(factor(action_type))) %>% 
  ggplot(., aes(x = action_type))+
  geom_boxplot(
    aes(ymin = action_number_min, 
        lower = action_number_y25, middle = action_number_median, upper = action_number_y75,
        ymax = action_number_max),
    stat = "identity"
  )+
  theme_mark(plots_pane = T)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r}
house_bill_actions %>% 
  group_by(action_type) %>% 
  mutate(mean_num = mean(action_number)) %>% 
  ungroup() %>% 
  arrange(mean_num) %>% 
  mutate(action_type = fct_inorder(factor(action_type))) %>% 
  ggplot(., aes(x = action_type, y = action_number))+
  geom_boxplot()+
  labs(title = "In what order do actions typically occur?", x = NULL)+
  theme_mark(plots_pane = T)

```

```{r}
house_bill_actions %>% 
  filter(bill_id == sample(bill_id, 1)) -> sample_bill_actions

sample_bill_actions %>% 
  # Plot
  ggplot(., aes(x = actionDate))+
  # Line connecting points
  geom_line(aes(y = ..count.., group = bill_id), stat = "count", size = .8, alpha = .8)+
  # Points using the count of each action type on a given date
  geom_point(aes(colour = action_type, size = ..count..), stat = "count")+
  labs(title = "Bill actions over time", 
       x = "Action Date", y = "# of actions")+
  scale_size(guide = "none", range = c(2,7))+
  theme_mark(plots_pane = T)
```




Let's look only at those bills that became law

```{r}
house_bill_actions %>% 
  # Combine bill type and number to create an ID
  unite(bill_id, billType, billNumber, sep = "-", remove = F) %>% 
  group_by(bill_id) %>% 
  filter("BecameLaw" %in% action_type) %>%
  ungroup() %>% 
  ggplot(., aes(x = action_ts, y = action_number))+
  geom_line(aes(group = bill_id))+
  facet_wrap(~billType, scales = "free_y")
```


```{r}
house_bill_actions %>% 
  # Combine bill type and number to create an ID
  unite(bill_id, billType, billNumber, sep = "-", remove = F) %>% 
  group_by(bill_id) %>% 
  filter("BecameLaw" %in% action_type)
```



```{r}
house_bill_actions %>% 
  ggplot(., aes(x = ))
```


```{r}
sample_bill_df[["actions"]][[1]] %>% 
  distinct(action_type, actionDate, action_committee_name)
```


Why are there multiple of what seem to be the same action?

```{r}
read_xml(sample_bill_file) %>% 
  xml_child("bill") %>% 
  xml_child("actions") %>% 
  xml_find_all("item") %>% 
  map(xml_contents)
```


