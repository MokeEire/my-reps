---
title: "Explore Bill Status bulk data"
output: 
  html_notebook:
    df_print: paged
---

```{r setup}
library(extrafont)
library(tictoc)
library(furrr)
library(here)
library(reactable)
plan(multisession)
source("R/parsing_functions.R")
```

I have downloaded all the different bill types for the 117th congress from https://www.govinfo.gov/bulkdata/BILLSTATUS/117/.
Below is the structure of this directory

```{r}
fs::dir_tree(here("data", "BILLSTATUS", "117"), recurse = F)
```

# Parse House bills

First we'll parse bills which were introduced in the house, or the bill types beginning with "h".
With the directory structure, I create a list of files by bill type.

```{r}
house_bill_types = list.files(here("data", "BILLSTATUS","117"), pattern = "^h")

(house_bill_folders = here("data", "BILLSTATUS", "117", 
                          house_bill_types))

house_bill_files = map(house_bill_folders, list.files, full.names = T) %>% 
  set_names(house_bill_types)

```

Let's check how many bill XML files are in each folder.
It seems house-originated bills (H.R.) are by far the most common, while simple resolutions (H. Res.) are the second most common.
Joint resolutions (H.J. Res.) and concurrent resolutions are introduced much less frequently.

```{r}
house_bill_files  %>% 
  map(length)
```

## Examine single bill

What does the data look like for a single bill?

```{r}
# Sample a bill
sample_bill_file = sample(house_bill_files$hr, 1)

# Extract the bill status data
sample_bill_df = future_map_dfr(sample_bill_file, extract_bill_status)

# View the bill's contents
glimpse(sample_bill_df)

```


```{r}
select(sample_bill_df, where(negate(is_list))) %>% 
  reactable(
    columns = list(
      congress = colDef(width = 60),
      billType = colDef(name = "Bill Type", width = 50),
      billNumber = colDef(name = "Bill #", width = 40),
      title = colDef(name = "Bill Title", width = 160),
      createDate = colDef(name = "Created", format = colFormat(date = T, locales = "en-GB")),
      latestAction_actionDate = colDef(name = "Latest Action Date", format = colFormat(date = T, locales = "en-GB")),
      latestAction_text = colDef(name = "Latest Action", width = 160),
      updateDate = colDef(name = "Updated", format = colFormat(date = T, locales = "en-GB")),
      introducedDate = colDef(name = "Introduced", format = colFormat(date = T, locales = "en-GB"))
    )
  )
```
### Actions

What actions were are taken on a bill?
After a bill is introduced, how do members of congress interact with it? 


```{r}
sample_bill_df %>% 
  select(where(negate(is_list)), actions) %>% 
  unnest(actions) %>% 
  nest(action_codes = c(actionCode, action_sourceSystem_code, action_sourceSystem_name)) %>% 
  mutate(action_n = map_dbl(action_codes, nrow))
```


```{r}
sample_bill_df %>% 
  select(billType, billNumber, title, introducedDate, where(is_list)) %>%
  unnest(actions) %>% 
  # Combine bill type and number to create an ID
  unite(bill_id, billType, billNumber, sep = "-", remove = F) %>% 
  # Sort cols and rows
  select(bill_id, billType:introducedDate, action_type, actionDate, action_text, action_committee_name, action_sourceSystem_name) %>% 
  arrange(billType, billNumber, actionDate, action_type) %>% 
  # Plot
  ggplot(., aes(x = actionDate))+
  # Line connecting points
  geom_line(aes(y = ..count.., group = bill_id), stat = "count", size = .7)+
  # Points using the count of each action type on a given date
  geom_point(aes(colour = action_type, size = ..count..), stat = "count")+
  labs(title = "Bill actions over time")+
  theme_mark(plots_pane = T)
```

Can we scale this up to see what actions are taken on bills on a timeline?

```{r}
(house_bills = map(house_bill_files, future_map_dfr, extract_bill_status))

saveRDS(house_bills, here("data", "cleaned", "BILLSTATUS_117_House.Rds"))
```

```{r}
(house_bill_actions = map(house_bills, select, billNumber, title, billType, actions) %>% 
  map_dfr(unnest, actions) %>% 
  arrange(billType, billNumber, actionDate, actionTime) %>% 
  select(billType, billNumber, title, actionDate, actionTime, action_type, action_text, action_sourceSystem_name, actionCode, action_committee_name) %>% 
  group_by(billType, billNumber) %>% 
  mutate(action_number = row_number(),
         became_law = ("BecameLaw" %in% action_type), .after = actionTime) %>% 
  ungroup() %>% 
  # Combine bill type and number to create an ID
  unite(bill_id, billType, billNumber, sep = "-", remove = F) %>% 
  mutate(action_ts = make_datetime(year = year(actionDate),
                                   month = month(actionDate), 
                                   day = day(actionDate), 
                                   hour = coalesce(hour(actionTime), 0), 
                                   min = coalesce(minute(actionTime), 0), 
                                   sec = coalesce(second(actionTime), 0), 
                                   tz = "US/Eastern")))
```

```{r}
house_bill_actions %>% 
  filter(billType == "HR") %>% 
  select(bill_id, title, became_law, action_sourceSystem_name, action_ts, action_type, actionCode, action_text) %>% 
  mokeR::reactable(resizable = T, showPageSizeOptions = T, fullWidth = F, groupBy = "bill_id", style = list(fontSize = 14),
      columns = list(action_text = colDef(width = 480))
  )
```


```{r}
house_bill_actions %>% 
  group_by(bill_id) %>% 
  mutate(became_law = ("BecameLaw" %in% action_type)) %>% 
  ggplot(., aes(x = action_ts, y = action_number))+
  geom_line(aes(group = bill_id, colour = became_law))+
  facet_wrap(~billType, scales = "free_y")
```

```{r}
house_bill_actions %>% 
  count(billType, action_type, wt = n_distinct(bill_id)) %>% 
  arrange(billType, desc(n))
```
What does calendars mean as an action?

```{r}
house_bill_actions %>% 
  filter(action_type == "Calendars") %>% 
  distinct(action_type, action_text)
```


Can we get an idea of the order of actions based on their average position in the order?

```{r}
house_bill_actions %>% 
  group_by(action_type) %>% 
  summarise(across(action_number, list(min = min, mean = mean, median = median, max = max)))
```

```{r}
house_bill_actions %>% 
  ggplot(., aes(x = action_number))+
  geom_histogram(aes(group = action_type, fill = action_type))
```


Let's look only at those bills that became law

```{r}
house_bill_actions %>% 
  # Combine bill type and number to create an ID
  unite(bill_id, billType, billNumber, sep = "-", remove = F) %>% 
  group_by(bill_id) %>% 
  filter("BecameLaw" %in% action_type) %>%
  ungroup() %>% 
  ggplot(., aes(x = action_ts, y = action_number))+
  geom_line(aes(group = bill_id))+
  facet_wrap(~billType, scales = "free_y")
```
```{r}
house_bill_actions %>% 
  # Combine bill type and number to create an ID
  unite(bill_id, billType, billNumber, sep = "-", remove = F) %>% 
  group_by(bill_id) %>% 
  filter("BecameLaw" %in% action_type)
```



```{r}
house_bill_actions %>% 
  ggplot(., aes(x = ))
```


```{r}
sample_bill_df[["actions"]][[1]] %>% 
  distinct(action_type, actionDate, action_committee_name)
```


Why are there multiple of what seem to be the same action?

```{r}
read_xml(sample_bill_file) %>% 
  xml_child("bill") %>% 
  xml_child("actions") %>% 
  xml_find_all("item") %>% 
  map(xml_contents)
```


